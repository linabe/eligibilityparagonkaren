```{r}

tabElFunc <- function(pop, nr = NULL, export = FALSE) {

  ### Literal scenario
  pdata_tmp <- pdata %>%
    filter(!!enexpr(pop)) %>%
    mutate(eligi = rowSums(select(
      .,
      matches("^ie_in|^ie_ex")
    ) == FALSE) > 0)
  impdata_tmp <- impdata %>%
    filter(!!enexpr(pop)) %>%
    mutate(eligi_imp = rowSums(select(
      .,
      matches("^ie_in|^ie_ex")
    ) == FALSE) > 0)
  
  tabeldata.lit <- left_join(pdata_tmp,
    impdata_tmp %>% select(PatID, eligi_imp),
    by = "PatID"
  ) 

  tab.imp.lit <- CreateTableOne(
    vars = tabvars,
    strata = "eligi_imp",
    data = tabeldata.lit
  )

  tab.imp.lit <- print(tab.imp.lit,
    varLabels = TRUE, missing = FALSE, printToggle = FALSE,
    nonnormal = tabvars, test = TRUE,
    catDigits = 1, contDigits = 1,
    explain = FALSE
  )

  tab.comp.lit <- CreateTableOne(
    vars = tabvars,
    strata = "eligi",
    data = tabeldata.lit %>% filter(nomissing)
  )

  tab.comp.lit <- print(tab.comp.lit,
    varLabels = TRUE, missing = FALSE, printToggle = FALSE,
    nonnormal = tabvars, test = TRUE,
    catDigits = 1, contDigits = 1,
    explain = FALSE
  )

  tab.missasel.lit <- CreateTableOne(
    vars = tabvars,
    strata = "eligi",
    data = tabeldata.lit
  )

  tab.missasel.lit <- print(tab.missasel.lit,
    varLabels = TRUE, missing = FALSE, printToggle = FALSE,
    nonnormal = tabvars, test = TRUE,
    catDigits = 1, contDigits = 1,
    explain = FALSE
  )

  ### Pragmatic scenario

  pdata_tmp <- pdata %>%
    filter(!!enexpr(pop)) %>%
    mutate(eligi = rowSums(select(
      .,
      matches("^ie_in_pragscen|^ie_in_labscen_in_pragscen|^ie_ex_pragscen|^ie_ex_labscen_ex_pragscen")
    ) == FALSE) > 0)
  impdata_tmp <- impdata %>%
    filter(!!enexpr(pop)) %>%
    mutate(eligi_imp = rowSums(select(
      .,
      matches("^ie_in_pragscen|^ie_in_labscen_in_pragscen|^ie_ex_pragscen|^ie_ex_labscen_ex_pragscen")
    ) == FALSE) > 0)
  
  tabeldata.prag <- left_join(
    pdata_tmp,
    impdata_tmp %>% select(PatID, eligi_imp),
    by = "PatID"
  ) %>%
    mutate_if(is_character, factor)

  tab.imp.prag <- CreateTableOne(
    vars = tabvars,
    strata = "eligi_imp",
    data = tabeldata.prag
  )

  tab.imp.prag <- print(tab.imp.prag,
    varLabels = TRUE, missing = FALSE, printToggle = FALSE,
    nonnormal = tabvars, test = TRUE,
    catDigits = 1, contDigits = 1,
    explain = FALSE
  )

  tab.comp.prag <- CreateTableOne(
    vars = tabvars,
    strata = "eligi",
    data = tabeldata.prag %>% filter(nomissing)
  )

  tab.comp.prag <- print(tab.comp.prag,
    varLabels = TRUE, missing = FALSE, printToggle = FALSE,
    nonnormal = tabvars, test = TRUE,
    catDigits = 1, contDigits = 1,
    explain = FALSE
  )

  tab.missasel.prag <- CreateTableOne(
    vars = tabvars,
    strata = "eligi",
    data = tabeldata.prag
  )

  tab.missasel.prag <- print(tab.missasel.prag,
    varLabels = TRUE, missing = FALSE, printToggle = FALSE,
    nonnormal = tabvars, test = TRUE,
    catDigits = 1, contDigits = 1,
    explain = FALSE
  )

  all <- cbind(
    tab.imp.lit[, 1:3], tab.comp.lit[, 1:3], tab.missasel.lit[, 1:3],
    tab.imp.prag[, 1:3], tab.comp.prag[, 1:3], tab.missasel.prag[, 1:3]
  )

  colnames(all) <- c(
    rep(c("Eligible", "Not eligible", "p-value"), 6)
  )

  ## Export to Excel
  if (export) write.xlsx(all, paste0("./output/tabs/tabByEligibilty_pragmatic_karen_", Sys.Date(), ".xlsx"), rowNames = TRUE)

  rownamesadj <- rownames(all)

  ## white space removed in kable function. Add HTML space.
  rownamesadj <- sub("^ ", "&nbsp;", rownamesadj)

  ## add footer to indicated which variabels are used as eligibilty variables
  rownamesadj <- ifelse(stri_extract_first_words(rownamesadj) %in% c(
    elvars,
    "raas"
  ),
  paste0(rownamesadj, footnote_marker_symbol(1)), rownamesadj
  )

  rownames(all) <- rownamesadj


  myHeader <- c(" " = 1, "Imputed data" = 3, "Complete case" = 3, "Missing as eligible" = 3,
                "Imputed data" = 3, "Complete case" = 3, "Missing as eligible" = 3)
  names(myHeader) <- c(" ", "Imputed data", "Complete case", "Missing as eligible", 
                       "Imputed data", "Complete case", "Missing as eligible")

  footnote(mykable(all, row.names = TRUE) %>%
    add_header_above(myHeader),
  symbol = c("Used in eligibility criteria. Note that other variables that are subsets or in other ways related to the variables used in the eligibilty criteria should be viewed with caution"),
  general = c("Categorical variables are presented with n (%) and tested with chi2-test and continous variables are presented with median [q1-q3] and tested with Mann-Whitney U test")
  )
}
```

### Overall
```{r Elbaseoverall}
tabElFunc(!is.na(IND_YRS))
```

### Subgroup: Females
```{r Elbasef}
tabElFunc(IND_GEN == "Female")
```

### Subgroup: Males
```{r Elbasem}
tabElFunc(IND_GEN == "Male")
```

### Subgroup: EF <= 57%
```{r Elbaseu57}
tabElFunc(EFgroup57 == "<=57")
```

### Subgroup: EF > 57%
```{r Elbaseo57}
tabElFunc(EFgroup57 == ">57")
```

